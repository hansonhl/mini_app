# Web App for Wechat Mini Application

This is a practice project from this imooc web development course 
https://coding.imooc.com/learn/list/265.html

All static files (`web/static`) and front-end design files for the 
miniapp (`mina/*`) are provided by the instructor.

## Usage

How to run server in development mode

`$ ./run_dev_server.sh`

## Project Structure

### Admin Account management 

All backend python code is in `controllers/account/account.py`.

**Relevant database tables/ORM models:** 

- `User` (see `common/models/user.py`)

**Functionality**

- List all accounts using pagination (`templates/account/index.html`, `static/js/account/index.js`), search member by name
    status and/or cellphone number
- List detailed account info and access log (`templates/account/info.html`)
- Adding and editing accounts (`templates/account/set.html`, `static/js/account/set.js`): functions are integrated together
- Deleting and recovering accounts (`templates/account/index.html`, `static/js/account/index.js`)

### Credentials and authentication

All backend python code is in `controllers/user/user.py`, some helper functions defined in `common/libs/user_utils.py`

**Functionality**

- Login (`templates/user/login.html`, `static/js/user/login.js`)
- Edit account info (`templates/user/edit.html`, `static/js/user/edit.js`)
- Reset password (`templates/user/reset_pwd.html`, `static/js/user/reset_pwd.js`)

### Client-side member management

All backend python code is in `controllers/members/member.py`
A new member is created whenever a new account logs in through the WeChat miniapp front end. No function to create a 
new member.

**Relevant database tables/ORM models**

- `Member` (`common/models/member.py`)
- `OauthMemberBind` (`common/models/oath_member_bind.py`) links application member with credential info provided
   by official WeChat api (e.g. `openid`)

**Functionality**

- List all members (`templates/member/index.html`, `static/js/member/index.js`), search member by name and/or status
- List detailed member info (`templates/member/info.html`)
- Editing members (`templates/member/set.html`, `static/js/member/set.js`)
- Deleting and recovering accounts (`templates/member/index.html`, `static/js/member/index.js`)

### Wechat login

`mina/app.js` defines a lot of helper functions such as:

- `app.console()` for logging
- `app.getRequestHeader()` to allow request data from front end to back end be treated as an html form, 
- `app.buildUrl()` as a general url manager
- `app.getCache()` and `app.setCache()` to store cookie-type data locally in wechat front end

**Relevant database tables/ORM models**

Same as above

**Functionality**

- Frontend login interface and logic (`mina/pages/index/{index.js, index.wxml}`):
    1. First send request to backend to see if user has logged in before (`index.js: checkLogin()`), if yes, redirect to
    `food/index` (`index.js: goToIndex()`)
    2. If user has not logged in before, send request to backend
- Backend member management (`controllers/api/member.py`)
    Some helper functions defined in `common/libs/member_utils.py`
    1. Front end request provides `login_code`, passes this on to WeChat official API to obtain `openid` which is a 
    user's unique identifier per WeChat application.
    2. Registers new members by adding new entries to databases Member and OauthMemberBind
    
    
### Food information and management

All backend code is in `controllers/food/food.py`

**Relevant database tables/ORM models**

- `Food` (`common/models/food.py`) contains basic info about a food item that is displayed on the food ordering app
- `FoodCat` (`common/models/food_cat.py`) separate table/model to manage different types of food
- `FoodStockChangeLog` (`common/models/food_stock_change_log.py`) new record for each change in the stock of a dish
- `FoodSaleChangeLog` (`common/models/food_sale_change_log.py`)
- `Image` (`common/models/images.py`) table to manage food images that can be uploaded through the admin website

**Functionality**

- Creating/editing info for each food item (`templates/food/set.html`, `static/js/food/set.js`) Uses the following
  plugins and functions:
    - `select2` to support Chinese pinyin for optimized drop-down menu search and select
    - `tagsinput` to quickly tags that can be attributed to each food item
    - `ueditor` to generate a rich text format-like description for each food item. One can load images through
      this editor
    - Image file uploading without need to refresh page using hidden <iframe> tag
    - Backend image handling logic:
        - Controllers to handle upload requests from the front end (`controllers/upload/upload.py`)
        - One helper function to handle all types of file uploading (`common/libs/utils.py: upload_by_file()`) - this
          takes the file descriptor generated by the flask interface (`flask.request.files`), saves a file locally and 
          creates a new database entry using the Image model
  
- List all food items (`templates/food/index.html`, `static/js/food/index.js`)
- Deleting and recovering food items from table view (`templates/food/index.html`, `static/js/food/index.js`)
- Detailed view of each food item (`templates/food/info.html`, `static/js/food/info.js`)
- List all food categories (`templates/food/cat.html`, `static/js/food/cat.js`)
- Deleting and recovering food categories from table view (`templates/food/cat.html`, `static/js/food/cat.js`)
- Creating/editing info for each food category (`templates/food/cat_set.html`, `static/js/food/cat_set.js`) 

*The last three are very similar to functionalities in member/user*

