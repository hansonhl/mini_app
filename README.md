# Web App for Wechat Mini Application

This is a practice project from this imooc web development course 
https://coding.imooc.com/learn/list/265.html

All static files (`web/static`) and front-end design files for the 
miniapp (`mina/*`) are provided by the instructor.

## Usage

How to run server in development mode

`$ ./run_dev_server.sh`

## Project Structure

### (Admin website) Admin Account management 

All backend python code is in `web/controllers/account/account.py`.

#### Relevant database schemas/ORM models: 

- `User` (see `common/models/user.py`)

#### Functionality

- List all accounts using pagination (`web/templates/account/index.html`, `web/static/js/account/index.js`), search member by name
    status and/or cellphone number
- List detailed account info and access log (`web/templates/account/info.html`)
- Adding and editing accounts (`web/templates/account/set.html`, `web/static/js/account/set.js`): functions are integrated together
- Deleting and recovering accounts (`web/templates/account/index.html`, `web/static/js/account/index.js`)

### (Admin website) Credentials and authentication

All backend python code is in `web/controllers/user/user.py`, some helper functions defined in `common/libs/user_utils.py`

#### Functionality

- Login (`web/templates/user/login.html`, `web/static/js/user/login.js`)
- Edit account info (`web/templates/user/edit.html`, `web/static/js/user/edit.js`)
- Reset password (`web/templates/user/reset_pwd.html`, `web/static/js/user/reset_pwd.js`)

### (Admin website) Food information and management

All backend code is in `web/controllers/food/food.py`

#### Relevant database schemas/ORM models

- `Food` (`common/models/food.py`) contains basic info about a food item that is displayed on the food ordering app
- `FoodCat` (`common/models/food_cat.py`) separate table/model to manage different types of food
- `FoodStockChangeLog` (`common/models/food_stock_change_log.py`) new record for each change in the stock of a dish
- `FoodSaleChangeLog` (`common/models/food_sale_change_log.py`)
- `Image` (`common/models/images.py`) table to manage food images that can be uploaded through the admin website

#### Functionality

- Creating/editing info for each food item (`web/templates/food/set.html`, `web/static/js/food/set.js`) Uses the following
  plugins and functions:
    - `select2` to support Chinese pinyin for optimized drop-down menu search and select
    - `tagsinput` to quickly tags that can be attributed to each food item
    - `ueditor` to generate a rich text format-like description for each food item. One can load images through
      this editor
    - Image file uploading without need to refresh page using hidden <iframe> tag
    - Backend image handling logic:
        - Controllers to handle upload requests from the front end (`web/controllers/upload/upload.py`)
        - One helper function to handle all types of file uploading (`common/libs/utils.py: upload_by_file()`) - this
          takes the file descriptor generated by the flask interface (`flask.request.files`), saves a file locally and 
          creates a new database entry using the Image model
  
- List all food items (`web/templates/food/index.html`, `web/static/js/food/index.js`)
- Deleting and recovering food items from table view (`web/templates/food/index.html`, `web/static/js/food/index.js`)
- Detailed view of each food item (`web/templates/food/info.html`, `web/static/js/food/info.js`)
- List all food categories (`web/templates/food/cat.html`, `web/static/js/food/cat.js`)
- Deleting and recovering food categories from table view (`web/templates/food/cat.html`, `web/static/js/food/cat.js`)
- Creating/editing info for each food category (`web/templates/food/cat_set.html`, `web/static/js/food/cat_set.js`) 

*The last three are very similar to functionalities in member/user*

### (Admin website) Customer member management

All backend python code is in `web/controllers/members/member.py`
A new member is created whenever a new account logs in through the WeChat miniapp front end. No function to create a 
new member.

#### Relevant database schemas/ORM models

- `Member` (`common/models/member.py`)
- `OauthMemberBind` (`common/models/oath_member_bind.py`) links application member with credential info provided
   by official WeChat api (e.g. `openid`)

#### Functionality

- List all members (`web/templates/member/index.html`, `web/static/js/member/index.js`), search member by name and/or status
- List detailed member info (`web/templates/member/info.html`)
- Editing members (`web/templates/member/set.html`, `web/static/js/member/set.js`)
- Deleting and recovering accounts (`web/templates/member/index.html`, `web/static/js/member/index.js`)

### (Wechat mini-app) Wechat login

`mina/app.js` defines a lot of helper functions such as:

- `app.console()` for logging
- `app.getRequestHeader()` to allow request data from front end to back end be treated as an html form, 
- `app.buildUrl()` as a general url manager
- `app.getCache()` and `app.setCache()` to store cookie-type data locally in wechat front end

#### Relevant database schemas/ORM models

Same as above

#### Functionality

- Frontend login interface and logic (`mina/pages/index/{index.js, index.wxml}`):
    1. First send request to backend to see if user has logged in before (`index.js: checkLogin()`), if yes, redirect to
    `food/index` (`index.js: goToIndex()`)
    2. If user has not logged in before, send request to backend
- Backend member management (`web/controllers/api/member.py`)
    Some helper functions defined in `common/libs/member_utils.py`
    1. Front end request provides `login_code`, passes this on to WeChat official API to obtain `openid` which is a 
    user's unique identifier per WeChat application.
    2. Registers new members by adding new entries to databases Member and OauthMemberBind
   
### (Wechat mini-app) Food info display

Backend code in `web/controllers/api/food.py`

#### Relevant database schemas/ORM models

- `Food`
- `FoodCat`
- `MemberComment` (to display comments)

#### Functionality

- Food information display on main page: `mina/pages/food/index.*`. `food/index` will kind of 
  serve as the main page of the app.
  - Sort by category
  - Load new items when user scrolls to the bottom of the page
- Detailed food information display: `mina/pages/food/info.*`
  - Display detailed rich-text description of food
  - Frontend logic to add food to cart
  - Displaying comments for food by users

### (Wechat mini-app) Shopping cart

Backend code in `web/controllers/api/cart.py`

#### Relevant database schemas/ORM models

`MemberCart` N-N relationship between Member and Food. Also denotes quantity of 
food item as descriptive attribute of the relation.

#### Functionality

See `mina/pages/cart/index.*` for front-end code.

- Selecting items and deleting them from the cart
- Augment or decrement the number of items
- Link to order creation

### (Wechat mini-app) Order creation and submission

Backend code in `web/controllers/api/order.py:order_info()`, to pass on data to 
page displaying an order yet to be created (`mina/pages/order/index`).

`web/controllers/api/order.py:order_create()` creates an order. 
`common/libs/pay_utils.py:create_order()` is also important.

#### Relevant database schemas/ORM models

`PayOrder` - one table to store all information for different stages of an order
during its lifecycle (see below). A `PayOrder` is dependent on the existence of
one `Member`. It is linked to at least one `Food`.

#### The lifecycle of an order

TODO: This can be optimized using a finite state diagram. 

`pay_status` is the single status integer used on the front end for categorization
and display purposes. It is actually determined by composing 3 status integers,
denoting the state of payment (`status`), delivery (`deliver_status`) and 
whether the user has made a comment yet (`comment_status`).

- `pay_status = -8 (status = -8, deliver_status = -8, comment_status = 0)`  
  Order created, but user hasn't paid yet.   
  (user pays for order --> `-7`)  
  (user cancels order --> `0`)
- `pay_status = -7 (status = 1, deliver_status = -7, comment_status = 0)`  
  User paid for order, but store hasn't initiated delivery yet.  
  (store initiates delivery -> `-6`)
- `pay_status = -6 (status = 1, deliver_status = -6, comment_status = 0)`  
  Store delivered food, but user hasn't confirmed they received it yet.  
  (user confirms delivery -> `-5`)
- `pay_status = -5 (status = 1, deliver_status = 1, comment_status = 0)`  
  User confirmed they received the food, but hasn't given feedback on it.  
  (user makes a comment -> `1`)
- `pay_status = 1 (status = 1, deliver_status = 1, comment_status = 1)`  
  Transaction complete!
- `pay_status = 0 (status = 0, deliver_status = -8, comment_status = 0)`
  Transaction cancelled.

#### Functionality

- Displaying an order yet to be submitted (`mina/pages/order/index.*`). Connects
  with `web/controllers/api/order.py:order_info()`. On this page, a user can:
  - Change the delivery address (by resetting the default address, the default
    address is used automatically)
  - Add extra notes or instructions to the order
- Submit the order, and a new `PayOrder` entry will be created. Connects with
  `web/controllers/api/order.py:order_create()`

  
### (Wechat mini-app) Order listing and display

Backend code in `web/controllers/api/my.py:my_order()` and `my_order_info()`

#### Relevant database schemas/ORM models

`PayOrder`, same as above.

#### Functionality

`mina/pages/my/orderList.*`:

- Displays all orders of the currently logged-in member, grouping them in to 
  different stages of the order lifecycle. 
- Status `-8` (not yet paid), a user can cancel an order or pay for it.
- Status `-7` (paid, but not delivered), user could do nothing but wait for the 
  food to be delivered :( 
- Status `-6` (delivered, but not confirmed), user can confirm delivery.
- Status `-5` (confirmed, but hasn't commented), user can make a comment.
- Status `1` (complete)
- Status `0` (cancelled)
- Clicking on any order item that is listed will open its corresponding `orderInfo` page:

`mina/pages/my/orderInfo.*`:

- Displays detailed information about an order: stage of lifecycle, address,
  food name and quantity in order, price.


### (Wechat mini-app) Payment process

Backend code in `web/controllers/api/order.py:order_pay()`, `order_callback()`
and `order_callback_dev()`.

Some other important utils include `common/libs/wechat_utils.py:get_pay_info()`,
`common/libs/wechat_utils.py:order_success()` and `wechat_utils.py:add_pay_callback_data()`

#### Relevant database schemas/ORM models

`PayOrder`, same as above.
`PayOrderCallbackData`, records info returned from the WeChat official api after
a user has completed the payment process.

#### Functionality

See `pay_process_annotated.jpg`.

### (Wechat mini-app) Address management

Backend code in `web/controllers/api/my.py:my_address_{get|set|list|ops}.py` 

#### Relevant database schemas/ORM models

`MemberAddress`. `MemberAddress` is dependent on the existence of `Member`.
A member can have multiple address. 

#### Functionality

- Displaying addresses: `mina/pages/my/addressList.*`. User can click on one of
  them to set one as default. This page is accessible from `my/index` or `order/index`.
- Creating, editing, or deleting addresses: `mina/pages/my/addressSet.*`. This
  page is accessible by tapping on the edit icon on one of the list items in 
  `mina/pages/my/addressList`.

### (Wechat mini-app) Comment management

Backend code in `web/controllerse/api/my.py:my_comment_{add|list}.py`

#### Relevant database schemas/ORM models

`MemberComment`. Dependent on the existence of a `PayOrder`. A `PayOrder` can
only have at most one `MemberComment`.

#### Functionality

- Making a comment (`mina/pages/my/comment.*`). This is accessible from 
  `mina/pages/my/orderList` or `mina/pages/my/orderInfo`.
- Listing all comments made by the current user (`mina/pages/my/commentList.*`). 
  This is accessible from `mina/pages/my/index` or redirection from 
  `mina/pages/my/comment`.
- Comments are not meant to be edited.